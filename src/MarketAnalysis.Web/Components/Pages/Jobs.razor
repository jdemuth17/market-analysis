@page "/jobs"

@inject IPythonServiceClient PythonClient
@inject IDailyScanService ScanService
@inject IIndexDefinitionRepository IndexRepo
@inject IScanProgressTracker Progress
@inject IServiceProvider SP
@inject ISnackbar Snackbar

@implements IDisposable

<PageTitle>Jobs & Status - Market Analysis</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Jobs & Status</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Python Service</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (_checkingHealth)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <MudText>Checking...</MudText>
                }
                else
                {
                    <MudAlert Severity="@(_pythonHealthy ? Severity.Success : Severity.Error)">
                        @(_pythonHealthy ? "Python service is healthy" : "Python service is unavailable")
                    </MudAlert>
                }
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="CheckHealth">
                    Check Health
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Manual Scan</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-2">
                    Trigger a full market scan manually. The scan will run in the background
                    and may take several minutes depending on the number of tickers.
                </MudText>

                @if (Progress.IsRunning)
                {
                    <MudPaper Class="pa-3 mt-2" Elevation="0" Style="background: var(--mud-palette-background-grey);">
                        <MudText Typo="Typo.subtitle2" Class="mb-1">
                            Step @Progress.CurrentStepNumber/@Progress.TotalSteps: @Progress.CurrentStep
                        </MudText>
                        <MudProgressLinear Value="@Progress.OverallPercentage" Color="Color.Primary"
                                           Rounded="true" Size="Size.Large" Class="mb-1">
                            <MudText Typo="Typo.caption">@Progress.OverallPercentage.ToString("F0")%</MudText>
                        </MudProgressLinear>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @Progress.TickersProcessed / @Progress.TotalTickers tickers
                            @if (Progress.StartedAtUtc.HasValue)
                            {
                                var elapsed = DateTime.UtcNow - Progress.StartedAtUtc.Value;
                                @($" — {elapsed.Minutes}m {elapsed.Seconds}s elapsed")
                            }
                        </MudText>
                    </MudPaper>
                }
                else if (Progress.CompletedAtUtc.HasValue)
                {
                    var severity = Progress.ErrorMessage is null ? Severity.Success : Severity.Error;
                    var message = Progress.ErrorMessage is null
                        ? $"Last scan completed at {Progress.CompletedAtUtc.Value.ToLocalTime():g}"
                        : $"Last scan failed: {Progress.ErrorMessage}";
                    <MudAlert Severity="severity" Dense="true" Class="mt-2">@message</MudAlert>
                }

                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    Automatic scans run weekdays at 6:00 PM ET via Hangfire.
                </MudAlert>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="TriggerScan" Disabled="Progress.IsRunning">
                    @if (Progress.IsRunning) { <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" /> }
                    Run Full Scan
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Hangfire Dashboard</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2" Class="mb-2">
                    View detailed job status, history, retries, and scheduled jobs in the Hangfire dashboard.
                </MudText>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                           Href="/hangfire" Target="_blank"
                           StartIcon="@Icons.Material.Filled.OpenInNew">
                    Open Hangfire Dashboard
                </MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Index Scans</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (_indexes.Any())
                {
                    <MudSimpleTable Dense="true" Hover="true">
                        <thead><tr><th>Index</th><th>Enabled</th><th>Tickers</th><th>Last Refreshed</th></tr></thead>
                        <tbody>
                            @foreach (var idx in _indexes)
                            {
                                <tr>
                                    <td>@idx.Name</td>
                                    <td>
                                        <MudSwitch T="bool" Value="idx.IsEnabled" ValueChanged="(v) => ToggleIndex(idx, v)" Color="Color.Primary" />
                                    </td>
                                    <td>@idx.Tickers.Length</td>
                                    <td>@idx.LastRefreshedUtc.ToLocalTime().ToString("g")</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
                else
                {
                    <MudText>No index definitions found.</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private bool _pythonHealthy;
    private bool _checkingHealth;
    private List<MarketAnalysis.Core.Entities.IndexDefinition> _indexes = new();
    private System.Threading.Timer? _pollTimer;

    protected override async Task OnInitializedAsync()
    {
        _indexes = await IndexRepo.GetAllAsync();
        await CheckHealth();

        // Start polling if a scan is already running
        if (Progress.IsRunning)
            StartPolling();
    }

    private async Task CheckHealth()
    {
        _checkingHealth = true;
        _pythonHealthy = await PythonClient.HealthCheckAsync();
        _checkingHealth = false;
    }

    private void TriggerScan()
    {
        if (Progress.IsRunning) return;

        Snackbar.Add("Scan started — this may take several minutes...", Severity.Info);

        _ = Task.Run(async () =>
        {
            try
            {
                using var scope = SP.CreateScope();
                var svc = scope.ServiceProvider.GetRequiredService<IDailyScanService>();
                await svc.RunFullScanAsync();
            }
            catch (Exception ex)
            {
                await InvokeAsync(() =>
                {
                    Snackbar.Add($"Scan failed: {ex.Message}", Severity.Error);
                    StateHasChanged();
                });
            }
        });

        StartPolling();
        StateHasChanged();
    }

    private void StartPolling()
    {
        _pollTimer?.Dispose();
        _pollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                StateHasChanged();

                if (!Progress.IsRunning && _pollTimer is not null)
                {
                    _pollTimer.Dispose();
                    _pollTimer = null;

                    if (Progress.ErrorMessage is null && Progress.CompletedAtUtc.HasValue)
                        Snackbar.Add("Full scan completed successfully!", Severity.Success);
                }
            });
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
    }

    private async Task ToggleIndex(MarketAnalysis.Core.Entities.IndexDefinition idx, bool enabled)
    {
        idx.IsEnabled = enabled;
        await IndexRepo.UpdateAsync(idx);
        Snackbar.Add($"{idx.Name} {(enabled ? "enabled" : "disabled")}", Severity.Info);
    }

    public void Dispose()
    {
        _pollTimer?.Dispose();
    }
}
